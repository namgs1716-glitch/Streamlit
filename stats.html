<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆì „ ê´€ë¦¬ í˜„í™© ë° ê¸°ìƒ</title>
    
    <script src="https://cdn.tailwindcss.com"></script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5ddbba0d44579d457d4c2d66b20e9b17"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <style>
        /* ê¸°ë³¸ í°íŠ¸ ë° ë°°ê²½ */
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; background-color: #ebedf0; }
        
        /* ê¸°ì¡´ stats.htmlì˜ ì»¨í…Œì´ë„ˆ/ì¹´ë“œ ìŠ¤íƒ€ì¼ ìœ ì§€ + Tailwind í˜¸í™˜ */
        .app-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .back-link { display: inline-block; margin-bottom: 15px; text-decoration: none; color: #555; font-weight: 600; font-size: 0.95rem; }
        .back-link:hover { color: #000; }
        
        .card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* ì§€ë„ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .weather-overlay {
            background: rgba(255, 255, 255, 0.95); padding: 6px 10px; border-radius: 20px;
            border: 1px solid #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center; font-size: 13px; font-weight: 700; color: #334155;
            display: flex; align-items: center; gap: 4px; pointer-events: none; white-space: nowrap;
        }
        .weather-icon { font-size: 18px; }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <div class="app-container">
        <div class="flex justify-between items-center mb-4">
            <a href="index.html" class="back-link">â† ë©”ì¸ìœ¼ë¡œ</a>
            <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š í˜„ì¥ ì•ˆì „ ìƒí™©ì‹¤</h2>
        </div>

        <div class="card overflow-hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-lg font-bold flex items-center gap-2">ğŸŒ¤ï¸ ì‹¤ì‹œê°„ í˜„ì¥ ê¸°ìƒë°˜</h3>
                <button id="btnMyLoc" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-sm hover:bg-indigo-700 transition">ğŸ“ ë‚´ í˜„ì¥ ìœ„ì¹˜ ì°¾ê¸°</button>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <div class="relative w-full lg:w-2/3 h-[400px] rounded-xl overflow-hidden border border-gray-200 shadow-inner group">
                    <div id="map" class="absolute inset-0 w-full h-full"></div>
                    <div class="absolute top-3 left-3 bg-white/90 p-3 rounded-lg shadow text-xs z-10 border border-indigo-50">
                        <p class="font-bold text-indigo-800">ğŸ“¢ ì‚¬ìš©ë²•</p>
                        <p class="text-gray-600">ğŸ‘† ì§€ë„ì˜ ì§€ì—­ì„ í´ë¦­í•˜ë©´</p>
                        <p class="text-gray-600">ìƒì„¸ ë‚ ì”¨ì™€ ì•ˆì „ ê°€ì´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>

                <div class="w-full lg:w-1/3 flex flex-col">
                    <div class="mb-4">
                        <h2 id="locTitle" class="text-xl font-bold text-gray-800">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                        <p id="stnInfo" class="text-xs text-gray-400 mt-1">ì§€ë„ì—ì„œ í˜„ì¥ í´ë¦­</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-slate-50 p-3 rounded-xl border text-center">
                            <div class="text-xs text-gray-500 mb-1">í’ì† (m/s)</div>
                            <div id="val_ws" class="text-2xl font-black text-gray-300">-</div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border text-center">
                            <div class="text-xs text-gray-500 mb-1">ê°•ìˆ˜ëŸ‰ (mm)</div>
                            <div id="val_rn" class="text-2xl font-bold text-gray-300">-</div>
                        </div>
                        <div class="bg-white p-2 rounded-lg border text-center">
                            <div class="text-xs text-gray-500">ê¸°ì˜¨</div>
                            <div id="val_ta" class="text-lg font-bold">-</div>
                        </div>
                        <div class="bg-white p-2 rounded-lg border text-center">
                            <div class="text-xs text-gray-500">ìŠµë„</div>
                            <div id="val_hm" class="text-lg font-bold">-</div>
                        </div>
                    </div>

                    <div id="safetyGuide" class="hidden flex-1 bg-white border rounded-xl p-3 shadow-sm">
                        <div class="flex items-center gap-2 mb-2 pb-2 border-b">
                            <span class="text-lg">ğŸ‘·</span>
                            <h3 class="font-bold text-sm text-gray-700">ì‘ì—… ì•ˆì „ ê°€ì´ë“œ</h3>
                        </div>
                        <div id="guideList" class="space-y-2 text-sm overflow-y-auto max-h-[120px]"></div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // --- 1. ê¸°ìƒ ê´€ë ¨ ì„¤ì • ë° í•¨ìˆ˜ ---
        const SIDO_REG_MAP = {
            "ì„œìš¸íŠ¹ë³„ì‹œ": "11B10101", "ë¶€ì‚°ê´‘ì—­ì‹œ": "11H20201", "ëŒ€êµ¬ê´‘ì—­ì‹œ": "11H10701",
            "ì¸ì²œê´‘ì—­ì‹œ": "11B20201", "ê´‘ì£¼ê´‘ì—­ì‹œ": "11F20501", "ëŒ€ì „ê´‘ì—­ì‹œ": "11C20401",
            "ìš¸ì‚°ê´‘ì—­ì‹œ": "11H20101", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ": "11C20404", "ê²½ê¸°ë„": "11B20601",
            "ê°•ì›íŠ¹ë³„ìì¹˜ë„": "11D10301", "ì¶©ì²­ë¶ë„": "11C10301", "ì¶©ì²­ë‚¨ë„": "11C20101", 
            "ì „ë¶íŠ¹ë³„ìì¹˜ë„": "11F10201", "ì „ë¼ë‚¨ë„": "11F20301", "ê²½ìƒë¶ë„": "11H10501",
            "ê²½ìƒë‚¨ë„": "11H20301", "ì œì£¼íŠ¹ë³„ìì¹˜ë„": "11G00201"
        };
        const GEO_SIDO = "/assets/geo/sido.geojson"; // ê²½ë¡œ í™•ì¸ í•„ìš”

        document.addEventListener('DOMContentLoaded', async function() {
            // === [Part 1] ì§€ë„ ë° ë‚ ì”¨ ë¡œì§ ===
            const mapContainer = document.getElementById('map');
            if (window.kakao && window.kakao.maps) {
                const map = new kakao.maps.Map(mapContainer, { center: new kakao.maps.LatLng(36.3, 127.8), level: 13 });
                let selectedMarker = null;
                let nationalWeatherData = null;

                // 1-1. ì „êµ­ ë‚ ì”¨ DB ë¡œë“œ
                try {
                    const res = await fetch('/.netlify/functions/kma-latest');
                    const json = await res.json();
                    if(json.ok) nationalWeatherData = json.items;
                } catch(e) { console.error("ì „êµ­ ë‚ ì”¨ ë¡œë“œ ì‹¤íŒ¨", e); }

                // 1-2. GeoJSON ë¡œë“œ ë° ê·¸ë¦¬ê¸°
                try {
                    const res = await fetch(GEO_SIDO);
                    const geo = await res.json();
                    
                    geo.features.forEach(feat => {
                        const name = feat.properties.CTP_KOR_NM;
                        const regId = SIDO_REG_MAP[name];
                        
                        const path = [];
                        const geom = feat.geometry;
                        const coords = geom.type === 'MultiPolygon' ? geom.coordinates : [geom.coordinates];
                        coords.forEach(poly => poly.forEach(ring => path.push(ring.map(c => new kakao.maps.LatLng(c[1], c[0])))));

                        const polygon = new kakao.maps.Polygon({
                            map: map, path: path,
                            strokeWeight: 1, strokeColor: '#64748b', strokeOpacity: 0.5,
                            fillColor: '#fff', fillOpacity: 0.1
                        });

                        // ì˜¤ë²„ë ˆì´ í‘œì‹œ
                        if (nationalWeatherData && regId) {
                            const wData = nationalWeatherData.find(i => i.regId === regId);
                            if (wData) {
                                const center = turf.centroid(feat);
                                const [lon, lat] = center.geometry.coordinates;
                                let icon = "â˜€ï¸", bg = "#fff";
                                const wf = (wData.wf || "").replace(/"/g, "");
                                
                                if (wf.includes("ë¹„")) { icon = "ğŸŒ§ï¸"; bg = "#eff6ff"; polygon.setOptions({fillColor: '#3b82f6', fillOpacity: 0.15}); }
                                else if (wf.includes("ëˆˆ")) { icon = "â„ï¸"; bg = "#f0f9ff"; }
                                else if (wf.includes("êµ¬ë¦„") || wf.includes("íë¦¼")) { icon = "â˜ï¸"; bg = "#f8fafc"; }

                                const content = `<div class="weather-overlay" style="background:${bg}"><span class="weather-icon">${icon}</span><span>${wData.ta ? wData.ta + 'â„ƒ' : '-'}</span></div>`;
                                new kakao.maps.CustomOverlay({ map: map, position: new kakao.maps.LatLng(lat, lon), content: content, yAnchor: 1 });
                            }
                        }

                        // ì´ë²¤íŠ¸
                        kakao.maps.event.addListener(polygon, 'mouseover', () => polygon.setOptions({fillOpacity: 0.3, strokeColor: '#2563eb'}));
                        kakao.maps.event.addListener(polygon, 'mouseout', () => polygon.setOptions({fillOpacity: 0.1, strokeColor: '#64748b'}));
                        kakao.maps.event.addListener(polygon, 'click', (mouseEvent) => {
                            const latLng = mouseEvent.latLng;
                            displayMarker(latLng);
                            fetchObservation(latLng.getLat(), latLng.getLng(), name);
                        });
                    });
                } catch (e) { console.error("ì§€ë„ ê·¸ë¦¬ê¸° ì‹¤íŒ¨", e); }

                function displayMarker(latLng) {
                    if (selectedMarker) selectedMarker.setMap(null);
                    selectedMarker = new kakao.maps.Marker({ position: latLng, map: map });
                    map.panTo(latLng);
                }

                // ë‚´ ìœ„ì¹˜ ë²„íŠ¼
                document.getElementById('btnMyLoc').addEventListener('click', () => {
                    if(navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(pos => {
                            const lat = pos.coords.latitude;
                            const lon = pos.coords.longitude;
                            const latLng = new kakao.maps.LatLng(lat, lon);
                            map.setLevel(9);
                            displayMarker(latLng);
                            fetchObservation(lat, lon, "í˜„ ìœ„ì¹˜");
                        });
                    } else alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                });
            } else {
                console.error("ì¹´ì¹´ì˜¤ë§µ ë¡œë“œ ì‹¤íŒ¨");
            }

            // === [Part 2] ê´€ì¸¡ê°’ API í˜¸ì¶œ í•¨ìˆ˜ ===
            async function fetchObservation(lat, lon, regionName) {
                const infoEl = document.getElementById('stnInfo');
                document.getElementById('locTitle').textContent = regionName || "ì„ íƒ ì§€ì—­";
                infoEl.innerHTML = '<span class="loader"></span> ë°ì´í„° ìˆ˜ì‹  ì¤‘...';
                ['ws','rn','ta','hm'].forEach(id => document.getElementById('val_'+id).textContent = '-');

                try {
                    const res = await fetch(`/.netlify/functions/kma-observation?lat=${lat}&lon=${lon}`);
                    const json = await res.json();
                    if(!json.ok) throw new Error(json.error);

                    const { station, data } = json;
                    infoEl.textContent = `ğŸ“¡ ${station.name} ê´€ì¸¡ì†Œ ê¸°ì¤€`;

                    const setVal = (id, v, color=false) => {
                        const el = document.getElementById('val_' + id);
                        el.textContent = (v !== null) ? v : "-";
                        el.className = (color && v >= 10) ? "text-2xl font-black text-red-600" : 
                                       (color && v >= 8) ? "text-2xl font-bold text-orange-500" : 
                                       "text-2xl font-bold text-gray-800";
                    };

                    setVal('ws', data.ws, true);
                    setVal('rn', data.rn, true);
                    document.getElementById('val_ta').textContent = data.ta || "-";
                    document.getElementById('val_hm').textContent = data.hm || "-";
                    
                    updateSafetyGuide(data);
                } catch(e) {
                    infoEl.innerHTML = `<span class="text-red-500">ìˆ˜ì‹  ì‹¤íŒ¨</span>`;
                }
            }

            function updateSafetyGuide(obs) {
                const list = document.getElementById('guideList');
                const box = document.getElementById('safetyGuide');
                list.innerHTML = '';
                let risks = [];

                if ((obs.ws || 0) >= 10) risks.push({lv:'crit', msg:"ğŸš¨ [ê°•í’] íƒ€ì›Œí¬ë ˆì¸ ì‘ì—… ì¤‘ì§€"});
                else if ((obs.ws || 0) >= 8) risks.push({lv:'warn', msg:"âš ï¸ [ê°•í’] ê³ ì†Œì‘ì—…/ë‚™í•˜ë¬¼ ì£¼ì˜"});
                if ((obs.rn || 0) > 0) risks.push({lv:'warn', msg:"ğŸŒ§ï¸ [ìš°ì²œ] ë¯¸ë„ëŸ¬ì§/ê°ì „ ì£¼ì˜"});
                if ((obs.ta || 0) >= 33) risks.push({lv:'crit', msg:"ğŸ”¥ [í­ì—¼] íœ´ì‹ì‹œê°„ ì¤€ìˆ˜"});
                if ((obs.ta || 0) <= -5) risks.push({lv:'warn', msg:"â„ï¸ [í•œíŒŒ] ë³´ì˜¨ ì–‘ìƒ ê´€ë¦¬"});

                box.classList.remove('hidden');
                if (risks.length > 0) {
                    risks.forEach(r => {
                        const bg = r.lv === 'crit' ? 'bg-red-50 text-red-700' : 'bg-yellow-50 text-yellow-700';
                        list.innerHTML += `<div class="p-2 rounded border text-xs font-medium ${bg}">${r.msg}</div>`;
                    });
                } else {
                    list.innerHTML = `<div class="p-2 rounded border bg-green-50 text-green-700 text-center text-xs">âœ… ê¸°ìƒ ìƒíƒœ ì–‘í˜¸</div>`;
                }
            }

        });
    </script>
</body>
</html>