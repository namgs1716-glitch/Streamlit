<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSI ì±—ë´‡ ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        
        .login-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input[type="password"], input[type="text"], textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 100px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        
        .container { display: flex; gap: 20px; display: none; } /* ë¡œê·¸ì¸ ì „ì—” ìˆ¨ê¹€ */
        .log-section { flex: 1; background: white; padding: 15px; border-radius: 8px; max-height: 600px; overflow-y: auto; }
        .teach-section { flex: 1; background: white; padding: 15px; border-radius: 8px; height: fit-content; }
        
        .log-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .log-item:hover { background-color: #eef7ff; }
        .log-item small { color: #888; }
        .log-user { font-weight: bold; color: #d9534f; }
    </style>
</head>
<body>

    <h2>ğŸ‘®â€â™‚ï¸ AI í•™ìŠµ ê´€ë¦¬ì</h2>

    <div class="login-box" id="login-area">
        <p>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.keyCode==13) login()">
        <button onclick="login()">ë¡œê·¸ì¸ & ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <div class="container" id="main-area">
        
        <div class="log-section">
            <h3>ğŸ“ ë‹µë³€ ì‹¤íŒ¨ ë¡œê·¸</h3>
            <div id="log-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div class="teach-section">
            <h3>ğŸ§  ì§€ì‹ ì£¼ì…í•˜ê¸°</h3>
            <input type="hidden" id="target-log-id">
            <label>ì§ˆë¬¸ (ì‚¬ìš©ìê°€ ë¬¼ì–´ë³¼ ë§)</label>
            <input type="text" id="teach-q" placeholder="ì˜ˆ: ë¶€ì‚°ì§€ì—­ ê°•í’ ê¸°ì¤€ì€?">
            
            <label>ì •ë‹µ (AIê°€ ë‹µë³€í•  ë‚´ìš©)</label>
            <textarea id="teach-a" placeholder="ì˜ˆ: ë¶€ì‚°ì§€ì—­ì€ í•´ì•ˆê°€ íŠ¹ì„±ìƒ..."></textarea>
            
            <button onclick="teachAI()">í•™ìŠµ ì‹œí‚¤ê¸°</button>
        </div>
    </div>

    <script>
        let password = "";

        async function login() {
            password = document.getElementById('admin-pw').value;
            if (!password) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            // ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
            const result = await callAdminAPI('get_logs');
            
            if (result.error) {
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + result.error);
            } else {
                document.getElementById('login-area').style.display = 'none';
                document.getElementById('main-area').style.display = 'flex';
                renderLogs(result.logs);
            }
        }

        async function callAdminAPI(action, data = {}) {
            try {
                const res = await fetch('/.netlify/functions/admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, password, ...data })
                });
                return await res.json();
            } catch (e) {
                console.error(e);
                return { error: "ì„œë²„ í†µì‹  ì˜¤ë¥˜" };
            }
        }

        function renderLogs(logs) {
            const list = document.getElementById('log-list');
            list.innerHTML = "";

            if (!logs || logs.length === 0) {
                list.innerHTML = "<p>ğŸ‰ ë‹µë³€ ì‹¤íŒ¨í•œ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            logs.forEach(log => {
                const div = document.createElement('div');
                div.className = 'log-item';
                div.innerHTML = `
                    <div class="log-user">Q: ${log.user_message}</div>
                    <small>${new Date(log.created_at).toLocaleString()}</small>
                `;
                // í´ë¦­í•˜ë©´ ì˜¤ë¥¸ìª½ ì…ë ¥ì°½ì— ìë™ ì±„ìš°ê¸°
                div.onclick = () => {
                    document.getElementById('teach-q').value = log.user_message;
                    document.getElementById('target-log-id').value = log.id;
                    document.getElementById('teach-a').focus();
                };
                list.appendChild(div);
            });
        }

        async function teachAI() {
            const q = document.getElementById('teach-q').value;
            const a = document.getElementById('teach-a').value;
            const id = document.getElementById('target-log-id').value; // ë¡œê·¸ ID (ìˆìœ¼ë©´ ì²˜ë¦¬ë¨)

            if (!q || !a) return alert("ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            if (!confirm("ì´ ë‚´ìš©ì„ AIì—ê²Œ í•™ìŠµì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?")) return;

            const result = await callAdminAPI('teach', { q, a, id });

            if (result.success) {
                alert("âœ… í•™ìŠµ ì™„ë£Œ! ì´ì œ ì±—ë´‡ì´ ì´ ë‚´ìš©ì„ ì••ë‹ˆë‹¤.");
                document.getElementById('teach-q').value = "";
                document.getElementById('teach-a').value = "";
                document.getElementById('target-log-id').value = "";
                
                // ë¡œê·¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                const refresh = await callAdminAPI('get_logs');
                renderLogs(refresh.logs);
            } else {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + (result.error || "ì•Œ ìˆ˜ ì—†ìŒ"));
            }
        }
    </script>
</body>
</html>