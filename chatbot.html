<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSI ì±—ë´‡</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">â† ë©”ì¸ìœ¼ë¡œ</a>
        <h2>ğŸ¤– CSI ì•ˆì „ ê°€ì´ë“œ</h2>

        <div id="chat-box">
            <div class="message bot">ì•ˆë…•í•˜ì„¸ìš”! ê±´ì„¤ê³µì‚¬ ì•ˆì „ê´€ë¦¬ ì¢…í•©ì •ë³´ë§(CSI) ë° ì•ˆì „ ìˆ˜ì¹™ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.</div>
        </div>

        <div class="input-area">
            <input type="text" id="user-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì—”í„°ë¡œ ì „ì†¡)" onkeypress="if(event.keyCode==13) sendMsg()">
            <button class="btn" onclick="sendMsg()">ì „ì†¡</button>
        </div>
    </div>

    <script>
        // âš ï¸ import ë¬¸ê³¼ apikey.jsëŠ” ì´ì œ í•„ìš” ì—†ìŠµë‹ˆë‹¤! (ë³´ì•ˆìƒ ì‚­ì œ)
        
        async function sendMsg() {
            const input = document.getElementById('user-input');
            const chatBox = document.getElementById('chat-box');
            const msg = input.value;
            
            if (!msg) return;

            // 1. ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ í‘œì‹œ
            chatBox.innerHTML += `<div class="message user">${msg}</div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // ë¡œë”© í‘œì‹œ (ì„ íƒì‚¬í•­)
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot';
            loadingDiv.textContent = 'ê·œì •ì„ ì°¾ì•„ë³´ê³  ìˆìŠµë‹ˆë‹¤...';
            chatBox.appendChild(loadingDiv);

            try {
                // 2. ğŸ”¥ ì—¬ê¸°ê°€ í•µì‹¬! Geminië¥¼ ì§ì ‘ ë¶€ë¥´ì§€ ì•Šê³ , ìš°ë¦¬ ì„œë²„(chat.js)ë¥¼ ë¶€ë¦…ë‹ˆë‹¤.
                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: msg })
                });

                const data = await response.json();
                
                // ë¡œë”© ë©”ì‹œì§€ ì‚­ì œ
                chatBox.removeChild(loadingDiv);

                // 3. ì„œë²„(chat.js)ê°€ ì¤€ ë‹µë³€ í‘œì‹œ
                if (data.reply) {
                    // ì¤„ë°”ê¿ˆ ë¬¸ì(\n)ë¥¼ HTML íƒœê·¸(<br>)ë¡œ ë³€í™˜í•´ì„œ ì´ì˜ê²Œ ë³´ì—¬ì£¼ê¸°
                    const formattedReply = data.reply.replace(/\n/g, '<br>');
                    chatBox.innerHTML += `<div class="message bot">${formattedReply}</div>`;
                } else {
                    chatBox.innerHTML += `<div class="message bot">âš ï¸ ì˜¤ë¥˜: ${data.error || 'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.'}</div>`;
                }

            } catch (error) {
                chatBox.removeChild(loadingDiv);
                console.error('Error:', error);
                chatBox.innerHTML += `<div class="message bot">âš ï¸ ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
            }
            
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>