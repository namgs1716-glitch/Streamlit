<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ì°¨ì‚¬ê³  ë¶„ì„</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">â† ë©”ì¸ìœ¼ë¡œ</a>
        <h2>ğŸ“¸ ì•„ì°¨ì‚¬ê³  ìœ„í—˜ ë¶„ì„</h2>

        <input type="file" id="image-input" accept="image/*" style="display:none;">
        
        <button class="btn" id="upload-trigger-btn">ğŸ“· ì‚¬ì§„ ì´¬ì˜ / ì—…ë¡œë“œ</button>
        
        <img id="preview" alt="ë¯¸ë¦¬ë³´ê¸°">
        
        <button class="btn" id="analyze-btn" style="display:none; background-color: #27ae60;">ğŸ” AI ë¶„ì„ ì‹œì‘</button>

        <div id="result-area" style="display:none;"></div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        // ì¤‘ìš”: apikey.js íŒŒì¼ì´ HTML íŒŒì¼ê³¼ ê°™ì€ í´ë”ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        import { CONFIG } from './apikey.js';

        // 1. DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const imageInput = document.getElementById('image-input');
        const uploadTriggerBtn = document.getElementById('upload-trigger-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const previewImg = document.getElementById('preview');
        const resultDiv = document.getElementById('result-area');

        // 2. ì‚¬ì§„ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ¨ê²¨ì§„ input í´ë¦­ ì—°ê²°
        uploadTriggerBtn.addEventListener('click', () => {
            imageInput.click();
        });

        // 3. ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ (onchange ëŒ€ì²´)
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                previewImg.src = URL.createObjectURL(file);
                previewImg.style.display = 'block';
                analyzeBtn.style.display = 'block';
                resultDiv.style.display = 'none';
            }
        });

        // 4. ë¶„ì„ ì‹œì‘ ê¸°ëŠ¥ (onclick ëŒ€ì²´)
        analyzeBtn.addEventListener('click', async () => {
            resultDiv.style.display = 'block';
            resultDiv.innerText = "â³ Geminiê°€ ìœ„í—˜ ìš”ì†Œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...";

            try {
                const genAI = new GoogleGenerativeAI(CONFIG.GEMINI_KEY);
                
                // ì¤‘ìš”: ëª¨ë¸ëª…ì„ 'gemini-1.5-flash'ë¡œ ìˆ˜ì • (2.5ëŠ” ì•„ì§ ê³µê°œ APIì— ì—†ìŠµë‹ˆë‹¤)
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                
                const file = imageInput.files[0];
                const base64Data = await fileToGenerativePart(file);

                const prompt = "ì´ ê±´ì„¤ í˜„ì¥ ì‚¬ì§„ì„ ë³´ê³  [ìœ„í—˜ ìš”ì†Œ / ì˜ˆìƒ ì‚¬ê³  / ì¡°ì¹˜ ì‚¬í•­ / ìœ„í—˜ ë“±ê¸‰] í˜•ì‹ìœ¼ë¡œ ê°„ë‹¨ëª…ë£Œí•˜ê²Œ ë³´ê³ ì„œë¥¼ ì¨ì¤˜.";
                
                const result = await model.generateContent([
                    prompt, 
                    base64Data
                ]);
                
                const response = await result.response;
                resultDiv.innerText = response.text();

            } catch (error) {
                console.error(error); // ì½˜ì†”ì—ë„ ìì„¸í•œ ì—ëŸ¬ ì¶œë ¥
                resultDiv.innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + error.message;
            }
        });

        // 5. íŒŒì¼ì„ Base64ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        async function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve({
                    inlineData: {
                        data: reader.result.split(',')[1],
                        mimeType: file.type
                    }
                });
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>